<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mapme.agriculture">
<title>Calculate Productivity Indicators • mapme.agriculture</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Calculate Productivity Indicators">
<meta property="og:description" content="mapme.agriculture">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mapme.agriculture</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-2">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/introduction.html">Introduction</a>
    <a class="dropdown-item" href="../articles/installation.html">Installation</a>
    <a class="dropdown-item" href="../articles/terminology.html">Terminology</a>
    <a class="dropdown-item" href="../articles/workflow.html">Workflow</a>
    <a class="dropdown-item" href="../articles/usage.html">Calculate Productivity Indicators</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">
<script src="usage_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Calculate Productivity Indicators</h1>
            
            <h4 data-toc-skip class="date">Last modified: 2021-12-01</h4>
      
      
      <div class="d-none name"><code>usage.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="getting-started">Getting Started<a class="anchor" aria-label="anchor" href="#getting-started"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mapme.agriculture</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/" class="external-link">terra</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></code></pre></div>
<p>In this documentation we are presenting how to use the mapme.wapor package to download and process data sets from the <a href="https://wapor.apps.fao.org/home" class="external-link">FAO WaPOR</a> API to calculate several indices to assess biomass water productivity. WaPOR makes available several layers at different resolutions concerned with agricultural productivity. While this package can be used do download several of these layers, we will focus on the ones that are required to calculate supported productivity indices. These product are:</p>
<ul>
<li>Total Biomass Productivity (TBP): This data layer indicates the total biomass production (kg/ha) for two distinct seasons every year</li>
<li>Phenology (PHE): This data layer indicates the decade the start and end of season in a given pixel was detected. It is used to aggregate other indicators according to the length of the respective season</li>
<li>Land Cover Classifcation (LCC): This data layer delivers a broad classification scheme of land cover /land use and it is used to focus the analysis on specific land covers</li>
<li>Transpiration (T): This data layer indicats decadal transpiration values (mm) for each pixel. It is used to calculate the total amount of transpired water by plants during the length of the growing season</li>
<li>Gross Biomass Water Productivity (GBWP): This data layer indicates the amount of water used in the production of biomass (kg/m³). It is a gross estimate because besides plant transpiration also soil evaporation and interception is included. The package will calculate net biomass water productivity based on the transpiration layer</li>
</ul>
</div>
<div class="section level2">
<h2 id="download-input-data">Download input data<a class="anchor" aria-label="anchor" href="#download-input-data"></a>
</h2>
<p>Above mentioned products are needed for the other functions to work properly. We can use the download function to download other products as well, however, this is out of scope for this vignette. In the code chunk below we show how the download utility can be used to query a spatio-temporal domain for download. Note that you will need a personal API key that can be acquired in the user section of the WaPOR <a href="https://wapor.apps.fao.org/home/WAPOR_2/1" class="external-link">website</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aoi</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"aoi.gpkg"</span>, package <span class="op">=</span> <span class="st">"mapme.agriculture"</span><span class="op">)</span><span class="op">)</span>
<span class="va">aoi</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">aoi</span>, <span class="fl">4326</span><span class="op">)</span> <span class="co"># transform to WGS84 because the API expects lat/lon coordinates</span>
<span class="va">collection</span> <span class="op">=</span> <span class="st">"WAPOR_2"</span> <span class="co"># wapor colletion 2.0</span>
<span class="va">products</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"TBP"</span> <span class="op">=</span> <span class="st">"L2_TBP_S"</span>,
                <span class="st">"PHE"</span> <span class="op">=</span> <span class="st">"L2_PHE_S"</span>,
                <span class="st">"LCC"</span> <span class="op">=</span> <span class="st">"L2_LCC_A"</span>, 
                <span class="st">"T"</span> <span class="op">=</span> <span class="st">"L2_T_D"</span>,
                <span class="st">"GBWP"</span> <span class="op">=</span> <span class="st">"L2_GBWP_S"</span><span class="op">)</span> <span class="co"># The products we want to download</span>

<span class="va">begin</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2009-01-01"</span><span class="op">)</span> <span class="co"># begin date is inclusive</span>
<span class="va">end</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2015-01-01"</span><span class="op">)</span> <span class="co"># end date is exclusive</span>
<span class="va">APIkey</span> <span class="op">=</span> <span class="st">"&lt;-your key goes here-&gt;"</span> <span class="co"># can be obtained in the profile section of the WAPOR website </span>
<span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"data"</span><span class="op">)</span>

<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html" class="external-link">length</a></span><span class="op">(</span><span class="va">products</span><span class="op">)</span><span class="op">)</span><span class="op">{</span> <span class="co"># download products in a loop</span>
  <span class="fu"><a href="../reference/wapor_queryRaster.html">wapor_queryRaster</a></span><span class="op">(</span>collection <span class="op">=</span> <span class="va">collection</span>,
                    product <span class="op">=</span> <span class="va">products</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,
                    aoi <span class="op">=</span> <span class="va">aoi</span>,
                    begin <span class="op">=</span> <span class="va">begin</span>,
                    end <span class="op">=</span> <span class="va">end</span>, 
                    APIkey <span class="op">=</span> <span class="va">APIkey</span>, 
                    outdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"input"</span>, package <span class="op">=</span> <span class="st">"mapme.agriculture"</span><span class="op">)</span>, 
                    cutline <span class="op">=</span> <span class="cn">FALSE</span>, 
                    tiled <span class="op">=</span> <span class="cn">TRUE</span>, 
                    compressed <span class="op">=</span> <span class="cn">TRUE</span>, 
                    overviews <span class="op">=</span> <span class="cn">TRUE</span>,
                    sleep_time <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># increase sleep time for larger extents to avoid being banned </span>
<span class="op">}</span></code></pre></div>
<p>The above function call will download the queried products to the data directory. Note that downloading larger raster extents can take a while because the FAO server will need to process the query. Make sure to increase the sleep time of the function to an appropriate value to avoid querying the server to frequently for the current status.</p>
</div>
<div class="section level2">
<h2 id="calculation-of-nbwp">Calculation of NBWP<a class="anchor" aria-label="anchor" href="#calculation-of-nbwp"></a>
</h2>
<p>With the package we deliver some previously downloaded raster files to showcase how we can process these. The very first step would be to calculate the Net Biomass Water Productivity, that is the ratio between biomass produced to transpiration only. For this we provide the wapor_nbwp function. Note that NBWP can only be calculated when data for transpiration from the previous year as well as the complete following year is available. The reason is that, depending on where we are on the globe, a growing season might start in the previous year and it might as well extend to the following year. That is also why the earliest year we can calculate NBWP is 2010, because WaPOR transpiration data is available from 2009 onwards. The function will cause an error either if a year before 2010 is queried or if the last year is later than the previous year at the time the function is called. Besides the numeric vector indicating the years we are interested in we need to supply the function with a single character vector of the input files. Note that the names of these files follow a certain standard so they should not be changed after download. Additionally, you should specify an output directory where two new directories are created. In the first step the function sums up the seasonal total sum of transpiration and outputs these rasters to a directory called “T_S”. In the next step the seasonal total biomass production is divided by the seasonal transpiration to get NBWP. These rasters are written to a directory called “NBWP”.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">input_files</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"input"</span>, package <span class="op">=</span> <span class="st">"mapme.agriculture"</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">T</span>, pattern <span class="op">=</span> <span class="st">".tif"</span>, full.names <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"intermediate"</span>, package <span class="op">=</span> <span class="st">"mapme.agriculture"</span><span class="op">)</span>, showWarnings <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="va">nbwp_files</span> <span class="op">=</span> <span class="fu"><a href="../reference/wapor_nbwp.html">wapor_nbwp</a></span><span class="op">(</span>input_files <span class="op">=</span> <span class="va">input_files</span>,
                        years <span class="op">=</span> <span class="fl">2010</span><span class="op">:</span><span class="fl">2014</span>, 
                        outdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"intermediate"</span>, package <span class="op">=</span> <span class="st">"mapme.agriculture"</span><span class="op">)</span>,
                        verbose <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="co">#&gt; Starting calculation for year 2010.</span>
<span class="co">#&gt; Starting to mask raster files according to mask values...</span>
<span class="co">#&gt; Starting calculation of seasonal transpiration for season S1...</span>
<span class="co">#&gt; Starting calculation of seasonal transpiration for season S2...</span>
<span class="co">#&gt; Starting calculation of seasonal NBWP...</span>
<span class="co">#&gt; Starting calculation for year 2011.</span>
<span class="co">#&gt; Starting to mask raster files according to mask values...</span>
<span class="co">#&gt; Starting calculation of seasonal transpiration for season S1...</span>
<span class="co">#&gt; Starting calculation of seasonal transpiration for season S2...</span>
<span class="co">#&gt; Starting calculation of seasonal NBWP...</span>
<span class="co">#&gt; Starting calculation for year 2012.</span>
<span class="co">#&gt; Starting to mask raster files according to mask values...</span>
<span class="co">#&gt; Starting calculation of seasonal transpiration for season S1...</span>
<span class="co">#&gt; Starting calculation of seasonal transpiration for season S2...</span>
<span class="co">#&gt; Starting calculation of seasonal NBWP...</span>
<span class="co">#&gt; Starting calculation for year 2013.</span>
<span class="co">#&gt; Starting to mask raster files according to mask values...</span>
<span class="co">#&gt; Starting calculation of seasonal transpiration for season S1...</span>
<span class="co">#&gt; Starting calculation of seasonal transpiration for season S2...</span>
<span class="co">#&gt; Starting calculation of seasonal NBWP...</span>
<span class="co">#&gt; Starting calculation for year 2014.</span>
<span class="co">#&gt; Starting to mask raster files according to mask values...</span>
<span class="co">#&gt; Starting calculation of seasonal transpiration for season S1...</span>
<span class="co">#&gt; Starting calculation of seasonal transpiration for season S2...</span>
<span class="co">#&gt; Starting calculation of seasonal NBWP...</span></code></pre></div>
<p>We can take a look at the NBWP files for the first season.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">nbwp_files</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"S1"</span>, <span class="va">nbwp_files</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="usage_files/figure-html/plot-nbwp-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="calculate-productivity-indicators">Calculate productivity indicators<a class="anchor" aria-label="anchor" href="#calculate-productivity-indicators"></a>
</h2>
<p>In the next step we are interested in calculating a number of indices from the NBWP as well as the input files. The supported indices are the following:</p>
<ul>
<li>land cover statistics: mode and median of landcover, year of breakpoint, frequency of specified land cover classes</li>
<li>the presence of a double season in a certain pixel</li>
<li>yearly values of the raw values of TBP, GBWP, NBWP</li>
<li>Global Land Productivity: Based on TBP, GBWP, and NBWP, the ratio a pixel achieves in a certain year in comparison of the 95%-quantile across all years</li>
<li>Yearly Land Productivity: the same as above except that the threshold value is calculated on the basis of the 95%-qunatile for each year</li>
<li>differences between epochs: the raw parameters and the productivity indices are averaged for two epochs and the difference between these two values is returned</li>
<li>linear trends for the raw parameters and the productivity indicators: each raster has two layers, the first is the estimate of the the trend, the second the p-value</li>
</ul>
<p>We can use the wapor_indices function to calculate the complete raster set that is written to the specifed output directory. The land cover classification map can be used to restrict the calculation to certain land cover types. When mask_values is omitted the raster files are not masked prior to calculation. Note that we can specify the number of cores for parallel computation. However, it is only advised to use this functionality for very large rasters. For example, when calculating the indices based on the rasters delivered with this package any parallel processing will substantially increase computation time because the extent is rather small.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">input_files2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_files</span>, <span class="va">nbwp_files</span><span class="op">)</span>
<span class="va">index_files</span> <span class="op">=</span> <span class="fu"><a href="../reference/wapor_indices.html">wapor_indices</a></span><span class="op">(</span><span class="va">input_files2</span>, 
                            years <span class="op">=</span> <span class="fl">2010</span><span class="op">:</span><span class="fl">2014</span>, 
                            mask_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>,<span class="fl">30</span><span class="op">)</span>, 
                            ncores <span class="op">=</span> <span class="fl">1</span>, 
                            epoch1 <span class="op">=</span> <span class="fl">2010</span><span class="op">:</span><span class="fl">2012</span>, 
                            epoch2 <span class="op">=</span> <span class="fl">2013</span><span class="op">:</span><span class="fl">2014</span>, 
                            outdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"output"</span>, package <span class="op">=</span> <span class="st">"mapme.agriculture"</span><span class="op">)</span>,
                            overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; Starting to mask LCC...</span>
<span class="co">#&gt; Calculation of LCC metrics...</span>
<span class="co">#&gt; Calculation to mask global productivity metric...</span>
<span class="co">#&gt; Calculation to mask yearly productivity metric...</span>
<span class="co">#&gt; Calculation of epoch differences...</span>
<span class="co">#&gt; Calculation of trends. This could take a while...</span>
<span class="co">#&gt; Double season identification...</span>
<span class="co">#&gt; Calculation differences in season numbers...</span>
<span class="co">#&gt; Writting output to disk...</span>
<span class="co">#&gt; Done!</span></code></pre></div>
<p>Let’s visualize both of the land productivity indicators for one of the selected land cover classes. We will start with visualizing the global indicator.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">index_files</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"20-nbwp-s1-lp1_global.tif"</span>, <span class="va">index_files</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="usage_files/figure-html/plot-global-1.png" width="700"></p>
<p>Now we will move to visualize the same parameter but this time it is based on a yearly threshold.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">index_files</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"20-nbwp-s1-lp1_yearly.tif"</span>, <span class="va">index_files</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="usage_files/figure-html/plot-yearly-1.png" width="700"></p>
<p>Differences are subtle, but note that these indicators were calculated only for pixels where the respective land cover classification was found to correspond to a value of 20. We can quickly cross-check this by visualizing the input land cover classification.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lcc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">input_files</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"LCC"</span>, <span class="va">input_files</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="va">lcc</span><span class="op">[</span><span class="va">lcc</span> <span class="op">!=</span>  <span class="fl">20</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">lcc</span><span class="op">)</span></code></pre></div>
<p><img src="usage_files/figure-html/plot-lcc-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="extract-zonal-statistics">Extract zonal statistics<a class="anchor" aria-label="anchor" href="#extract-zonal-statistics"></a>
</h2>
<p>Since we have now the calculated indices in the next step we are interested in extracting this information and summarizing it per polygon. To showcase this functionality we included an additional vector data set with a number of polygons in the study area.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aoi2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"aoi2.gpkg"</span>, package <span class="op">=</span> <span class="st">"mapme.agriculture"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Reading layer `aoi2' from data source </span>
<span class="co">#&gt;   `/home/runner/work/_temp/Library/mapme.agriculture/extdata/aoi2.gpkg' </span>
<span class="co">#&gt;   using driver `GPKG'</span>
<span class="co">#&gt; Simple feature collection with 10 features and 1 field</span>
<span class="co">#&gt; Geometry type: POLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 36.62841 ymin: 13.27759 xmax: 36.69996 ymax: 13.35452</span>
<span class="co">#&gt; Geodetic CRS:  WGS 84</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">lcc</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> 
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">aoi2</span>, add <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></code></pre></div>
<p><img src="usage_files/figure-html/plot-aoi-1.png" width="700"></p>
<p>For the extraction, we simply specify the path to the index files as well as the aoi to the wapor_extract function.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">extracted_values</span> <span class="op">=</span> <span class="fu"><a href="../reference/wapor_extract.html">wapor_extract</a></span><span class="op">(</span><span class="va">index_files</span>, <span class="va">aoi2</span><span class="op">)</span></code></pre></div>
<p>This will give us a list with different tibble objects representing different levels of the indicator extraction. From the output below we see that in the first object we find the main land cover statistcs. In the second object, the land cover frequency for the specified mask values is found. In the third object we get the averaged yearly values of the raw parameters as well as the productivity indicators. In the fourth object the number of double seasons is indicated while the difference in double seasons between epochs is found in the fifth object. For the raw parameters and the productivity indicators the difference between epochs are found in the sixth object while the trend parameters are found in the last one.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">extracted_values</span>, <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; List of 7</span>
<span class="co">#&gt;  $ lcc_stats          : tibble [49 × 3] (S3: tbl_df/tbl/data.frame)</span>
<span class="co">#&gt;  $ lcc_freq           : tibble [20 × 4] (S3: tbl_df/tbl/data.frame)</span>
<span class="co">#&gt;  $ indices            : tibble [1,800 × 7] (S3: tbl_df/tbl/data.frame)</span>
<span class="co">#&gt;  $ double_seasons     : tibble [100 × 5] (S3: tbl_df/tbl/data.frame)</span>
<span class="co">#&gt;  $ double_seasons_diff: tibble [20 × 4] (S3: tbl_df/tbl/data.frame)</span>
<span class="co">#&gt;  $ epoch_diffs        : tibble [240 × 7] (S3: tbl_df/tbl/data.frame)</span>
<span class="co">#&gt;  $ trends             : tibble [720 × 7] (S3: tbl_df/tbl/data.frame)</span></code></pre></div>
<p>Note, that all returned tibbles are formatted in a long format. The column ID specifies the index of in relation to the inputted aoi object. Thus if we wish to combine a certain table with the original aoi object we can proceed as follows:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aoi2</span><span class="op">$</span><span class="va">ID</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">aoi2</span><span class="op">)</span>
<span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">aoi2</span>, <span class="va">extracted_values</span><span class="op">$</span><span class="va">indices</span><span class="op">)</span>
<span class="co">#&gt; Joining, by = "ID"</span>
<span class="co">#&gt; Simple feature collection with 1800 features and 8 fields</span>
<span class="co">#&gt; Geometry type: POLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 36.62841 ymin: 13.27759 xmax: 36.69996 ymax: 13.35452</span>
<span class="co">#&gt; Geodetic CRS:  WGS 84</span>
<span class="co">#&gt; First 10 features:</span>
<span class="co">#&gt;    id ID year     value class parameter season  indicator</span>
<span class="co">#&gt; 1   1  1 2010 0.8484247    20      gbwp     s1 lp1_global</span>
<span class="co">#&gt; 2   1  1 2011 0.5608977    20      gbwp     s1 lp1_global</span>
<span class="co">#&gt; 3   1  1 2012 0.8596461    20      gbwp     s1 lp1_global</span>
<span class="co">#&gt; 4   1  1 2013 0.9893828    20      gbwp     s1 lp1_global</span>
<span class="co">#&gt; 5   1  1 2014 0.8706949    20      gbwp     s1 lp1_global</span>
<span class="co">#&gt; 6   1  1 2010 0.8675581    20      gbwp     s1 lp1_yearly</span>
<span class="co">#&gt; 7   1  1 2011 0.9136670    20      gbwp     s1 lp1_yearly</span>
<span class="co">#&gt; 8   1  1 2012 0.9292712    20      gbwp     s1 lp1_yearly</span>
<span class="co">#&gt; 9   1  1 2013 0.8974670    20      gbwp     s1 lp1_yearly</span>
<span class="co">#&gt; 10  1  1 2014 0.8717483    20      gbwp     s1 lp1_yearly</span>
<span class="co">#&gt;                              geom</span>
<span class="co">#&gt; 1  POLYGON ((36.62841 13.35452...</span>
<span class="co">#&gt; 2  POLYGON ((36.62841 13.35452...</span>
<span class="co">#&gt; 3  POLYGON ((36.62841 13.35452...</span>
<span class="co">#&gt; 4  POLYGON ((36.62841 13.35452...</span>
<span class="co">#&gt; 5  POLYGON ((36.62841 13.35452...</span>
<span class="co">#&gt; 6  POLYGON ((36.62841 13.35452...</span>
<span class="co">#&gt; 7  POLYGON ((36.62841 13.35452...</span>
<span class="co">#&gt; 8  POLYGON ((36.62841 13.35452...</span>
<span class="co">#&gt; 9  POLYGON ((36.62841 13.35452...</span>
<span class="co">#&gt; 10 POLYGON ((36.62841 13.35452...</span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="http://dariusgoergen.com/" class="external-link">Darius Görgen</a>, <a href="https://mapme-initiative.org/" class="external-link">MAPME-Initiative</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.0.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
